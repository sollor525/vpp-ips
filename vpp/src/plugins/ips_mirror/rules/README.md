# IPS Mirror Rules Module

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

IPS Mirror Rulesæ¨¡å—è´Ÿè´£å…¥ä¾µæ£€æµ‹è§„åˆ™çš„è§£æã€åŠ è½½ã€ç®¡ç†å’Œæ‰§è¡Œã€‚è¯¥æ¨¡å—å®ç°äº†åŸºäºSuricataè§„åˆ™è¯­æ³•çš„å®Œæ•´å…¥ä¾µæ£€æµ‹è§„åˆ™å¼•æ“ï¼Œæ”¯æŒå¤æ‚çš„è§„åˆ™åŒ¹é…æ¡ä»¶å’ŒåŠ¨ä½œæ‰§è¡Œã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

- **è§„åˆ™è§£æå™¨** (`ips_rule_parser.c`) - è§£æSuricataæ ¼å¼çš„è§„åˆ™
- **è§„åˆ™ç®¡ç†å™¨** (`ips_rules_module.c`) - ç®¡ç†è§„åˆ™çš„ç”Ÿå‘½å‘¨æœŸ
- **è§„åˆ™ç´¢å¼•** (`ips_rule_index.c`) - æä¾›é«˜æ•ˆçš„è§„åˆ™æŸ¥æ‰¾å’Œç´¢å¼•

### è®¾è®¡åŸåˆ™

æœ¬æ¨¡å—ä¸¥æ ¼éµå¾ªSOLIDåŸåˆ™ï¼š

- **å•ä¸€èŒè´£åŸåˆ™** - æ¯ä¸ªç»„ä»¶ä¸“æ³¨äºç‰¹å®šçš„è§„åˆ™å¤„ç†åŠŸèƒ½
- **å¼€é—­åŸåˆ™** - æ”¯æŒæ–°è§„åˆ™é€‰é¡¹çš„æ‰©å±•ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
- **é‡Œæ°æ›¿æ¢åŸåˆ™** - ä¸åŒç±»å‹çš„è§„åˆ™è§£æå™¨å¯ä»¥äº’æ¢
- **æ¥å£éš”ç¦»åŸåˆ™** - æä¾›æœ€å°åŒ–çš„æ¥å£ï¼Œé¿å…è‡ƒè‚¿çš„ä¾èµ–
- **ä¾èµ–å€’ç½®åŸåˆ™** - ä¾èµ–æŠ½è±¡æ¥å£è€Œéå…·ä½“å®ç°

## ğŸ“ æ–‡ä»¶ç»“æ„

```
rules/
â”œâ”€â”€ README.md                    # æœ¬æ–‡æ¡£
â”œâ”€â”€ ips_rule_parser.c           # ä¸»è¦è§„åˆ™è§£æå™¨ (1622è¡Œ)
â”œâ”€â”€ ips_rules_module.c          # è§„åˆ™ç®¡ç†æ¨¡å—
â”œâ”€â”€ ips_rule_index.c            # è§„åˆ™ç´¢å¼•å’ŒæŸ¥æ‰¾
â””â”€â”€ default.rules               # é»˜è®¤è§„åˆ™ç¤ºä¾‹
```

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### 1. è§„åˆ™è§£æ (ips_rule_parser.c)

æ”¯æŒ42ç§é«˜çº§è§„åˆ™é€‰é¡¹ï¼ŒåŒ…æ‹¬ï¼š

- **åŸºç¡€åŒ¹é…**: `content`, `pcre`, `depth`, `offset`, `distance`, `within`
- **åè®®æ£€æµ‹**: `http_method`, `http.uri`, `tls.sni`, `dns.query`
- **æµæ§åˆ¶**: `flow`, `flowbits`, `stream_reassemble`
- **å­—èŠ‚æ“ä½œ**: `byte_test`, `byte_jump`, `byte_extract`, `isdataat`
- **å…ƒæ•°æ®**: `sid`, `rev`, `gid`, `msg`, `classtype`, `priority`

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```c
// è§£æè§„åˆ™
ips_suricata_rule_t rule;
int result = ips_parse_suricata_rule(rule_string, &rule);
if (result == 0) {
    // è§„åˆ™è§£ææˆåŠŸï¼Œå¯ä»¥ä½¿ç”¨ruleè¿›è¡ŒåŒ¹é…
}
```

### 2. è§„åˆ™ç®¡ç† (ips_rules_module.c)

æä¾›å®Œæ•´çš„è§„åˆ™ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š

- **è§„åˆ™åŠ è½½**: ä»æ–‡ä»¶æˆ–å­—ç¬¦ä¸²åŠ è½½è§„åˆ™
- **è§„åˆ™éªŒè¯**: éªŒè¯è§„åˆ™çš„è¯­æ³•å’Œè¯­ä¹‰æ­£ç¡®æ€§
- **è§„åˆ™å¯ç”¨/ç¦ç”¨**: åŠ¨æ€æ§åˆ¶è§„åˆ™çš„æ¿€æ´»çŠ¶æ€
- **è§„åˆ™æ›´æ–°**: æ”¯æŒçƒ­æ›´æ–°ï¼Œæ— éœ€é‡å¯æœåŠ¡

**ä¸»è¦APIï¼š**
```c
// åŠ è½½è§„åˆ™æ–‡ä»¶
int ips_rules_load_file(const char *filename);

// æ·»åŠ è§„åˆ™
int ips_rules_add_rule(ips_suricata_rule_t *rule);

// åˆ é™¤è§„åˆ™
int ips_rules_remove_rule(u32 sid);

// å¯ç”¨/ç¦ç”¨è§„åˆ™
int ips_rules_set_rule_state(u32 sid, u8 enabled);
```

### 3. è§„åˆ™ç´¢å¼• (ips_rule_index.c)

æä¾›é«˜æ€§èƒ½çš„è§„åˆ™æŸ¥æ‰¾å’Œç´¢å¼•ï¼š

- **å¤šç»´ç´¢å¼•**: æ”¯æŒæŒ‰åè®®ã€ç«¯å£ã€IPç­‰å¤šç§æ¡ä»¶ç´¢å¼•
- **å¿«é€ŸæŸ¥æ‰¾**: åŸºäºå“ˆå¸Œè¡¨çš„O(1)å¤æ‚åº¦æŸ¥æ‰¾
- **å€™é€‰é€‰æ‹©**: æ™ºèƒ½é€‰æ‹©æœ€å¯èƒ½åŒ¹é…çš„è§„åˆ™å€™é€‰é›†

**æ€§èƒ½ç‰¹æ€§ï¼š**
- æ”¯æŒæ•°ä¸‡æ¡è§„åˆ™çš„é«˜æ•ˆç®¡ç†
- åŸºäºæ•°æ®åŒ…ç‰¹å¾çš„æ™ºèƒ½é¢„è¿‡æ»¤
- å†…å­˜ä¼˜åŒ–çš„ç´¢å¼•ç»“æ„

## ğŸ¯ æ”¯æŒçš„è§„åˆ™ç±»å‹

### 1. åè®®æ£€æµ‹è§„åˆ™
```suricata
alert http any any -> any any (msg:"HTTP Attack Detection";
    http.method; content:"POST"; http.uri; content:"/admin";
    sid:1000001; rev:1;)
```

### 2. å†…å®¹åŒ¹é…è§„åˆ™
```suricata
alert tcp any any -> any 80 (msg:"Web Attack Pattern";
    content:"<script>"; nocase; depth:200;
    sid:1000002; rev:1;)
```

### 3. æ­£åˆ™è¡¨è¾¾å¼è§„åˆ™
```suricata
alert tcp any any -> any 443 (msg:"TLS Certificate Attack";
    pcre:"/CN=[^\\s]+\\.malicious\\.com/";
    sid:1000003; rev:1;)
```

### 4. æµæ§åˆ¶è§„åˆ™
```suricata
alert tcp any any -> any any (msg:"Multi-step Attack";
    content:"login"; flow:to_server,established;
    flowbits:set,login.attempt;
    content:"admin"; flowbits:isset,login.attempt;
    sid:1000004; rev:1;)
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. è§„åˆ™ç¼–è¯‘ä¼˜åŒ–
- **Hyperscané›†æˆ**: è‡ªåŠ¨å°†PCREæ¨¡å¼è½¬æ¢ä¸ºHyperscané«˜æ€§èƒ½åŒ¹é…
- **é¢„ç¼–è¯‘**: è§„åˆ™åœ¨åŠ è½½æ—¶è¿›è¡Œé¢„ç¼–è¯‘ï¼Œæé«˜è¿è¡Œæ—¶æ€§èƒ½
- **åˆ†ç»„ä¼˜åŒ–**: æŒ‰åè®®å’Œç‰¹å¾å¯¹è§„åˆ™è¿›è¡Œåˆ†ç»„

### 2. å†…å­˜ä¼˜åŒ–
- **å†…å­˜æ± **: ä½¿ç”¨VPPå†…å­˜æ± å‡å°‘åŠ¨æ€åˆ†é…å¼€é”€
- **ç¼“å­˜å‹å¥½**: æ•°æ®ç»“æ„è®¾è®¡è€ƒè™‘CPUç¼“å­˜å±€éƒ¨æ€§
- **é›¶æ‹·è´**: é¿å…ä¸å¿…è¦çš„å†…å­˜æ‹·è´æ“ä½œ

### 3. å¹¶å‘ä¼˜åŒ–
- **çº¿ç¨‹å®‰å…¨**: æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘è§„åˆ™æŸ¥æ‰¾
- **æ— é”è®¾è®¡**: å°½å¯èƒ½ä½¿ç”¨æ— é”æ•°æ®ç»“æ„
- **NUMAæ„ŸçŸ¥**: è€ƒè™‘NUMAæ¶æ„çš„å†…å­˜è®¿é—®ä¼˜åŒ–

## ğŸ”„ é›†æˆæ¥å£

### 1. æ£€æµ‹å¼•æ“é›†æˆ
```c
// åŒ¹é…æ•°æ®åŒ…
int ips_rules_match_packet(ips_session_t *session,
                          vlib_buffer_t *buffer,
                          ips_detection_result_t *result);
```

### 2. ç®¡ç†æ¥å£é›†æˆ
```c
// CLIå‘½ä»¤æ³¨å†Œ
void ips_rules_cli_init(void);

// APIæ¥å£æ³¨å†Œ
void ips_rules_api_init(void);
```

## ğŸ“Š ç›‘æ§å’Œç»Ÿè®¡

### 1. è§„åˆ™æ€§èƒ½ç»Ÿè®¡
- è§„åˆ™åŒ¹é…æ¬¡æ•°
- å¹³å‡åŒ¹é…æ—¶é—´
- å†…å­˜ä½¿ç”¨æƒ…å†µ
- çƒ­ç‚¹è§„åˆ™è¯†åˆ«

### 2. è¿è¡Œæ—¶ç›‘æ§
```c
// è·å–è§„åˆ™ç»Ÿè®¡
void ips_rules_get_stats(ips_rules_stats_t *stats);

// é‡ç½®ç»Ÿè®¡è®¡æ•°å™¨
void ips_rules_reset_stats(void);
```

## ğŸ› ï¸ é…ç½®é€‰é¡¹

### 1. è§„åˆ™åŠ è½½é…ç½®
```c
typedef struct {
    u32 max_rules;              // æœ€å¤§è§„åˆ™æ•°é‡
    u8 auto_compile;            // è‡ªåŠ¨ç¼–è¯‘ä¼˜åŒ–
    u8 enable_hyperscan;        // å¯ç”¨HyperscanåŠ é€Ÿ
    char *rule_files[16];       // è§„åˆ™æ–‡ä»¶åˆ—è¡¨
} ips_rules_config_t;
```

### 2. æ€§èƒ½è°ƒä¼˜å‚æ•°
- `max_rules_per_group`: æ¯ä¸ªè§„åˆ™ç»„çš„æœ€å¤§è§„åˆ™æ•°
- `index_update_interval`: ç´¢å¼•æ›´æ–°é—´éš”
- `cache_size`: è§„åˆ™æŸ¥æ‰¾ç¼“å­˜å¤§å°

## ğŸš€ ä½¿ç”¨æŒ‡å—

### 1. åŸºæœ¬ä½¿ç”¨
```bash
# åŠ è½½è§„åˆ™æ–‡ä»¶
vpp# ips rules load /path/to/rules.rules

# æŸ¥çœ‹è§„åˆ™çŠ¶æ€
vpp# ips rules show

# å¯ç”¨/ç¦ç”¨è§„åˆ™
vpp# ips rules enable 1000001
vpp# ips rules disable 1000001
```

### 2. è§„åˆ™éªŒè¯
```bash
# éªŒè¯è§„åˆ™è¯­æ³•
vpp# ips rules validate /path/to/rules.rules

# æµ‹è¯•è§„åˆ™åŒ¹é…
vpp# ips rules test 1000001 "sample packet data"
```

## ğŸ” æ•…éšœæ’é™¤

### 1. å¸¸è§é—®é¢˜

**Q: è§„åˆ™åŠ è½½å¤±è´¥**
A: æ£€æŸ¥è§„åˆ™æ–‡ä»¶è¯­æ³•ï¼Œç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„Suricataè§„åˆ™æ ¼å¼

**Q: è§„åˆ™åŒ¹é…æ€§èƒ½å·®**
A: è€ƒè™‘å¯ç”¨HyperscanåŠ é€Ÿï¼Œä¼˜åŒ–è§„åˆ™é¡ºåºå’Œåˆ†ç»„

**Q: å†…å­˜ä½¿ç”¨è¿‡é«˜**
A: è°ƒæ•´max_ruleså‚æ•°ï¼Œæ¸…ç†æ— æ•ˆè§„åˆ™

### 2. è°ƒè¯•å·¥å…·
```bash
# æ˜¾ç¤ºè¯¦ç»†è§„åˆ™ä¿¡æ¯
vpp# ips rules detailed

# æŸ¥çœ‹è§„åˆ™ç¼–è¯‘çŠ¶æ€
vpp# ips rules compile-status

# ç›‘æ§è§„åˆ™æ€§èƒ½
vpp# ips rules monitor
```

## ğŸ“ˆ æœªæ¥å‘å±•

### 1. è®¡åˆ’åŠŸèƒ½
- **æœºå™¨å­¦ä¹ ä¼˜åŒ–**: åŸºäºæµé‡æ¨¡å¼ä¼˜åŒ–è§„åˆ™åŒ¹é…é¡ºåº
- **åˆ†å¸ƒå¼è§„åˆ™**: æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²çš„è§„åˆ™åŒæ­¥
- **è§„åˆ™å¯è§†åŒ–**: æä¾›è§„åˆ™å…³ç³»çš„å¯è§†åŒ–ç•Œé¢

### 2. æ€§èƒ½æå‡
- **GPUåŠ é€Ÿ**: åˆ©ç”¨GPUè¿›è¡Œå¤§è§„æ¨¡å¹¶è¡ŒåŒ¹é…
- **eBPFé›†æˆ**: ä½¿ç”¨eBPFè¿›è¡Œå†…æ ¸çº§åˆ«è¿‡æ»¤
- **ç¡¬ä»¶å¸è½½**: æ”¯æŒæ™ºèƒ½ç½‘å¡ç¡¬ä»¶åŠ é€Ÿ

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æŸ¥çœ‹ï¼š
- [ä¸»é¡¹ç›®æ–‡æ¡£](../README.md)
- [APIæ–‡æ¡£](../docs/api.md)
- [å¼€å‘æŒ‡å—](../docs/development.md)

---

*æœ¬æ–‡æ¡£æœ€åæ›´æ–°æ—¶é—´ï¼š2024-10-29*