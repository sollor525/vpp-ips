##############################################################################
# IPS Plugin
##############################################################################

# Set Hyperscan paths first
set(HYPERSCAN_ROOT "/root/qt/npatch_all_in_one/3rd-dep/hyperscan/hyperscan-5.4.0")
set(HYPERSCAN_INCLUDE_DIR "${HYPERSCAN_ROOT}/build")
set(HYPERSCAN_LIB_DIR "${HYPERSCAN_ROOT}/build/lib")

# Find Hyperscan library
find_library(HYPERSCAN_LIB
  NAMES hs libhs
  PATHS ${HYPERSCAN_LIB_DIR}
  NO_DEFAULT_PATH
)

# Find PCRE library
find_package(PkgConfig REQUIRED)
pkg_check_modules(PCRE REQUIRED libpcre)

add_vpp_plugin(ips
  SOURCES
  ips.c
  ips_api.c
  ips_cli.c
  ips_node.c
  ips_flow.c
  ips_detection.c
  ips_detection_advanced.c
  ips_detection_optimized.c
  ips_tcp_reorder.c
  ips_proto.c
  ips_response.c
  ips_rule_parser.c
  ips_rule_parser_advanced.c
  ips_multi_content.c
  ips_multi_content_parser.c
  ips_multi_content_detection.c
  ips_enhanced_parser.c
  ips_pcre_support.c
  ips_session.c
  ips_session_cli.c
  ips_session_timer.c
  ips_timer_api.c
  ips_timer_cli.c
  ips_logging.c

  API_FILES
  ips.api

  INSTALL_HEADERS
  ips.h
  ips_detection.h
  ips_proto.h
  ips_response.h
  ips_rule_parser.h
  ips_session_timer.h
  ips_logging.h

  LINK_LIBRARIES
  vppinfra
  vnet
  vlibapi
  vlibmemory

  COMPONENT
  vpp-plugin-ips
)

# Configure Hyperscan support
if(EXISTS "${HYPERSCAN_INCLUDE_DIR}/hs/hs.h" AND HYPERSCAN_LIB)
  message(STATUS "Found Hyperscan at ${HYPERSCAN_ROOT}")
  message(STATUS "Found Hyperscan library: ${HYPERSCAN_LIB}")

  # Add Hyperscan include directory and library
  target_include_directories(ips_plugin PRIVATE ${HYPERSCAN_INCLUDE_DIR})
  target_link_libraries(ips_plugin ${HYPERSCAN_LIB})
  target_compile_definitions(ips_plugin PRIVATE HAVE_HYPERSCAN=1)

  # Add runtime library path
  set_target_properties(ips_plugin PROPERTIES
    INSTALL_RPATH "${HYPERSCAN_LIB_DIR}"
    BUILD_WITH_INSTALL_RPATH TRUE
  )
else()
  if(NOT EXISTS "${HYPERSCAN_INCLUDE_DIR}/hs/hs.h")
    message(WARNING "Hyperscan headers not found at ${HYPERSCAN_INCLUDE_DIR}")
  endif()
  if(NOT HYPERSCAN_LIB)
    message(WARNING "Hyperscan library not found in ${HYPERSCAN_LIB_DIR}")
  endif()
endif()

# Create symbolic links to generated API files for IDE support
add_custom_command(TARGET ips_plugin POST_BUILD
  # Create links in current directory
  COMMAND ${CMAKE_COMMAND} -E create_symlink
    ${CMAKE_CURRENT_BINARY_DIR}/ips.api_enum.h
    ${CMAKE_CURRENT_SOURCE_DIR}/ips.api_enum.h
  COMMAND ${CMAKE_COMMAND} -E create_symlink
    ${CMAKE_CURRENT_BINARY_DIR}/ips.api_types.h
    ${CMAKE_CURRENT_SOURCE_DIR}/ips.api_types.h
  COMMAND ${CMAKE_COMMAND} -E create_symlink
    ${CMAKE_CURRENT_BINARY_DIR}/ips.api.c
    ${CMAKE_CURRENT_SOURCE_DIR}/ips.api.c
  COMMAND ${CMAKE_COMMAND} -E create_symlink
    ${CMAKE_CURRENT_BINARY_DIR}/ips.api.h
    ${CMAKE_CURRENT_SOURCE_DIR}/ips.api.h
  # Create ips subdirectory for IDE compatibility (handles ips/ips.api_*.h includes)
  COMMAND ${CMAKE_COMMAND} -E make_directory ${CMAKE_CURRENT_SOURCE_DIR}/ips
  COMMAND ${CMAKE_COMMAND} -E create_symlink
    ${CMAKE_CURRENT_BINARY_DIR}/ips.api_enum.h
    ${CMAKE_CURRENT_SOURCE_DIR}/ips/ips.api_enum.h
  COMMAND ${CMAKE_COMMAND} -E create_symlink
    ${CMAKE_CURRENT_BINARY_DIR}/ips.api_types.h
    ${CMAKE_CURRENT_SOURCE_DIR}/ips/ips.api_types.h
  COMMAND ${CMAKE_COMMAND} -E create_symlink
    ${CMAKE_CURRENT_BINARY_DIR}/ips.api.c
    ${CMAKE_CURRENT_SOURCE_DIR}/ips/ips.api.c
  COMMAND ${CMAKE_COMMAND} -E create_symlink
    ${CMAKE_CURRENT_BINARY_DIR}/ips.api.h
    ${CMAKE_CURRENT_SOURCE_DIR}/ips/ips.api.h
  COMMENT "Creating symbolic links to generated API files for IDE support"
)
